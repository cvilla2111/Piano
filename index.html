<!DOCTYPE html><html lang="en"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --gap: 30px;
            --header-height: 53px;
            --vh: max(100vh, 540px);
            --rect-height: calc((var(--vh) - 60px - 60px - 144px) / 9);
            --root-height: calc(var(--header-height) + 2 * var(--rect-height));
            --type-height: calc(var(--header-height) + 5 * var(--rect-height));
            --duration-height: calc(var(--header-height) + 2 * var(--rect-height));
            --type-top: calc(var(--gap) + var(--root-height) + var(--gap));
            --duration-top: calc(var(--type-top) + var(--type-height) + var(--gap));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
            min-height: 540px;
            overflow: hidden;
            background-color: #ebebe4;
        }

        body {
            width: 100%;
            height: 100%;
            min-height: 540px;
            background-color: #ebebe4;
            position: absolute;
        }

        .header {
            position: absolute;
            left: calc(var(--gap) + 31% + var(--gap));
            top: var(--gap);
            width: calc(100% - var(--gap) - 31% - var(--gap) - var(--gap));
            height: var(--header-height);
            background-color: #305060;
        }

        .left-container {
            position: absolute;
            left: var(--gap);
            top: var(--gap);
            width: 31%;
            height: calc(100% - var(--gap) - var(--gap));
            background-color: #f7f7f0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }

        .left-header {
            left: var(--gap);
            width: 31%;
            height: var(--header-height);
        }

        .left-bottom-header {
            left: var(--gap);
            width: 31%;
            height: var(--header-height);
        }

        .right-container {
            position: absolute;
            left: calc(var(--gap) + 31% + var(--gap));
            width: calc(100% - var(--gap) - 31% - var(--gap) - var(--gap));
        }

        .rect {
            height: var(--rect-height);
            border-style: solid;
            border-color: rgba(0,0,0,0.15);
            border-width: 0 2px 2px 0;
            color: rgba(0,0,0,0.5);
        }

        .root-note, .chord-type {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .root-note:hover, .chord-type:hover {
            filter: brightness(0.95);
        }

        .root-note.selected, .chord-type.selected {
            background-color: #d8fff7 !important;
        }

        .chord-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .chord-item:hover {
            filter: brightness(0.95);
        }

        .chord-item.selected {
            background-color: #d8fff7 !important;
        }

        .chord-item.playing {
            position: relative;
            overflow: hidden;
        }

        @keyframes beatPulse {
            0% {
                opacity: 0.3;
                transform: scaleX(0.3);
            }
            50% {
                opacity: 1;
                transform: scaleX(1.05);
            }
            100% {
                opacity: 0.85;
                transform: scaleX(1);
            }
        }

        .beat-indicator {
            position: absolute;
            top: 0;
            left: var(--beat-left, 0%);
            height: 100%;
            width: var(--beat-width, 0%);
            background-color: #a8e6ff;
            z-index: 0;
            transform-origin: left center;
        }

        .beat-indicator.animate {
            animation: beatPulse 0.2s ease-out forwards;
        }

        .chord-item.playing .chord-name,
        .chord-item.playing .chord-duration {
            position: relative;
            z-index: 1;
        }

        .duration-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .duration-item:hover {
            filter: brightness(0.95);
        }

        .duration-item.selected {
            background-color: #d8fff7 !important;
        }

        .tempo-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .tempo-item:hover {
            filter: brightness(0.95);
        }

        .tempo-item.selected {
            background-color: #d8fff7 !important;
        }

        .reverb-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .reverb-item:hover {
            filter: brightness(0.95);
        }

        .reverb-item.selected {
            background-color: #d8fff7 !important;
        }

        .chorus-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .chorus-item:hover {
            filter: brightness(0.95);
        }

        .chorus-item.selected {
            background-color: #d8fff7 !important;
        }

        .instrument-item {
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .instrument-item:hover {
            filter: brightness(0.95);
        }

        .instrument-item.selected {
            background-color: #d8fff7 !important;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 1000;
            justify-content: center;
            align-items: center;
            display: flex;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: #2a2a27;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s ease;
            border-radius: 8px;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(-3px);
        }

        .modal-title {
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: white;
            padding: 20px;
            padding-left: 30px;
            padding-right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-content {
            padding: 0 21px 0 21px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-inner-container {
            background-color: #f7f7f0;
            border-radius: 0;
            overflow: hidden;
            position: relative;
            flex: 1;
        }

        .modal-scroll-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }

        .modal-scroll-content {
            display: grid;
            gap: 0;
            min-width: 100%;
            align-content: start;
            will-change: transform;
        }

        .modal-scroll-content.animating {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .mixer-row {
            height: var(--rect-height);
            background-color: #fffff7;
            border-style: solid;
            border-color: rgba(0,0,0,0.15);
            border-width: 0 0 2px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: background-color 0.15s ease;
        }

        .mixer-row:hover {
            filter: brightness(0.95);
        }

        .mixer-row.selected {
            background-color: #d8fff7 !important;
        }

        .modal-footer {
            padding: 20px;
            padding-left: 30px;
            padding-right: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: white;
        }

        .modal-close-btn {
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            font-size: 14px;
            color: white;
            cursor: pointer;
        }

        .modal-close-btn:hover {
            opacity: 0.8;
        }

        .scroll-container {
            position: absolute;
            top: var(--header-height);
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }

        .scroll-content {
            display: grid;
            gap: 0;
            min-width: 100%;
            min-height: 100%;
            align-content: start;
            will-change: transform;
        }

        .scroll-content.animating {
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .header-chevron-left {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .header-title {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .header-chevron-right {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
        }

        .mobile-icons {
            display: none;
        }

        @media (max-width: 800px) {
            html, body {
                width: 100%;
                height: 100%;
                min-height: 100%;
                transform: none;
                left: 0;
                top: 0;
                position: fixed;
                display: flex;
                flex-direction: column;
            }

            .left-container {
                position: fixed;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                box-shadow: none;
            }

            .left-header {
                position: fixed;
                left: 0;
                right: 0;
                top: 0;
                width: 100%;
                height: 72px;
                flex-shrink: 0;
            }

            svg.header-chevron-left {
                left: 12px;
                width: 23px;
                height: 23px;
            }

            .header-title {
                left: 40px;
                transform: translateY(-50%);
                font-size: 19px !important;
            }

            svg.header-chevron-right {
                position: absolute;
                left: 100px;
                right: auto;
                top: 50%;
                transform: translateY(-50%);
                width: 23px;
                height: 23px;
            }

            .left-bottom-header {
                display: none;
            }

            .right-container,
            .right-header {
                display: none;
            }

            .desktop-only {
                display: none;
            }

            .mobile-icons {
                display: flex;
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                gap: 48px;
            }

            .mobile-icons svg {
                width: 21px !important;
                height: 21px !important;
            }
        }
    </style>
</head>
<body>
    <div class="left-container">
        <div class="scroll-container" style="top: var(--header-height); bottom: var(--header-height);">
            <div id="chord-list" class="scroll-content" style="grid-template-columns: 1fr;">
                <div class="rect chord-item" style="background-color: #fffff7; border-left: none; border-right: none; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);"><span class="chord-name">C Maj</span><span class="chord-duration">4 Beats</span></div>
            </div>
        </div>
    </div>
    <div class="header left-header">
        <i class="header-chevron-left" data-lucide="chevron-left" width="20" height="20" stroke-width="3" style="color: white;"></i>
        <span class="header-title" style="font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 16px; color: white;">01/01</span>
        <i class="header-chevron-right" data-lucide="chevron-right" width="20" height="20" stroke-width="3" style="color: white;"></i>
        <div class="mobile-icons">
            <i class="play-btn" data-lucide="play" width="24" height="24" style="color: white; fill: white; cursor: pointer;"></i>
            <i class="audio-lines-btn" data-lucide="audio-lines" width="24" height="24" stroke-width="2.5" style="color: white; cursor: pointer;"></i>
            <i data-lucide="rotate-ccw" width="24" height="24" stroke-width="2.5" style="color: white;"></i>
            <i data-lucide="menu" width="24" height="24" stroke-width="3" style="color: white;"></i>
        </div>
    </div>
    <div class="right-container" style="top: var(--gap); height: var(--root-height); background-color: #f7f7f0; box-shadow: 0 4px 8px rgba(0,0,0,0.25);">
        <div class="scroll-container">
            <div id="chord-root-grid" class="scroll-content" style="grid-template-columns: repeat(6, 1fr);">
                <div class="rect root-note" data-note="C" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">C</div>
                <div class="rect root-note" data-note="C#" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">C<sup>#</sup>/D<sup>b</sup></div>
                <div class="rect root-note" data-note="D" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">D</div>
                <div class="rect root-note" data-note="D#" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">D<sup>#</sup>/E<sup>b</sup></div>
                <div class="rect root-note" data-note="E" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">E</div>
                <div class="rect root-note" data-note="F" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">F</div>
                <div class="rect root-note" data-note="F#" style="background-color: #ffe5dd; border-bottom: none; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">F<sup>#</sup>/G<sup>b</sup></div>
                <div class="rect root-note" data-note="G" style="background-color: #d8ffd1; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">G</div>
                <div class="rect root-note" data-note="G#" style="background-color: #ffe5dd; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">G<sup>#</sup>/A<sup>b</sup></div>
                <div class="rect root-note" data-note="A" style="background-color: #d8ffd1; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">A</div>
                <div class="rect root-note" data-note="A#" style="background-color: #ffe5dd; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">A<sup>#</sup>/B<sup>b</sup></div>
                <div class="rect root-note" data-note="B" style="background-color: #d8ffd1; border-bottom: none; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">B</div>
            </div>
        </div>
    </div>
    <div class="header right-header">
        <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white;">Chord root</span>
        <i class="play-btn" data-lucide="play" width="18" height="18" style="position: absolute; right: 160px; top: 50%; transform: translateY(-50%); color: white; fill: white; cursor: pointer;"></i>
        <i class="audio-lines-btn" data-lucide="audio-lines" width="18" height="18" stroke-width="2.5" style="position: absolute; right: 112px; top: 50%; transform: translateY(-50%); color: white; cursor: pointer;"></i>
        <i data-lucide="rotate-ccw" width="18" height="18" stroke-width="2.5" style="position: absolute; right: 64px; top: 50%; transform: translateY(-50%); color: white;"></i>
        <i data-lucide="menu" width="18" height="18" stroke-width="3" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: white;"></i>
    </div>
    <div class="right-container" style="top: var(--type-top); height: var(--type-height); background-color: #f7f7f0; box-shadow: 0 4px 8px rgba(0,0,0,0.25);">
        <div class="scroll-container">
            <div id="chord-type-grid" class="scroll-content" style="grid-template-columns: repeat(6, 1fr);">
                <!-- Row 1: Maj, Min, Dim, 6, min6, Aug -->
                <div class="rect chord-type" data-type="Maj" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj</div>
                <div class="rect chord-type" data-type="Min" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min</div>
                <div class="rect chord-type" data-type="Dim" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Dim</div>
                <div class="rect chord-type" data-type="6" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">6</div>
                <div class="rect chord-type" data-type="min6" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">min6</div>
                <div class="rect chord-type" data-type="Aug" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Aug</div>
                <!-- Row 2: Maj7, Min7, 7, Maj9, Min9, 9 -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj9</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min9</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">9</div>
                <!-- Row 3: Maj11, Min11, 11, Maj13, Min13, 13 -->
                <div class="rect" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj11</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min11</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">11</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj13</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min13</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">13</div>
                <!-- Row 4: Sus2, Sus4, 5, Dim7, Aug7, Sus2Sus4 -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Sus2</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Sus4</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">5</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Dim7</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Aug7</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Sus2Sus4</div>
                <!-- Row 5: Add4, MinAdd4, 7Add4, Add9, MinAdd9, MinMaj7 -->
                <div class="rect" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Add4</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">MinAdd4</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7Add4</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Add9</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">MinAdd9</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">MinMaj7</div>
                <!-- Row 6: MinMaj9, MinMaj11, 7Sus2, 7Sus4, 9Sus4, DimAdd4 -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">MinMaj9</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">MinMaj11</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7Sus2</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7Sus4</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">9Sus4</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">DimAdd4</div>
                <!-- Row 7: AugAdd2, Maj7Sus4, Min7Add4, 6/9, 7/6, 9/6 -->
                <div class="rect" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">AugAdd2</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7Sus4</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7Add4</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">6/9</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7/6</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">9/6</div>
                <!-- Row 8: Maj(b5), Min(b5), Min(#5), Maj7(b5), Min7(b5), 7(b5) -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7(<sup>b</sup>5)</div>
                <!-- Row 9: Min6/9, Maj7(#5), Min7(#5), 7(#5), Maj7(b9), Min7(b9) -->
                <div class="rect" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min6/9</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7(<sup>b</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7(<sup>b</sup>9)</div>
                <!-- Row 10: 7(b9), Maj(#9), Maj7(#9), Min7(#9), 7(#9), Maj7(#11) -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7(<sup>b</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>#</sup>9)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7(<sup>#</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7(<sup>#</sup>9)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7(<sup>#</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj7(<sup>#</sup>11)</div>
                <!-- Row 11: 7(#11), Maj(b9), Min7(#11), 7/13, Maj(#5), Maj(#11) -->
                <div class="rect" style="background-color: #d8ffd1; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7(<sup>#</sup>11)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>b</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min7(<sup>#</sup>11)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">7/13</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>#</sup>11)</div>
                <!-- Row 12: 11(b9), Min11(b5), 9(b5), 9(#5), Maj9(#5), Aug7(#9) -->
                <div class="rect" style="background-color: #ffe5dd; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">11(<sup>b</sup>9)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Min11(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">9(<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">9(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj9(<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Aug7(<sup>#</sup>9)</div>
                <!-- Row 13: 13(b9), 13(#11), Maj(b9b5), Maj(b9#5), Maj(b9#11), Silence -->
                <div class="rect" style="background-color: #d8ffd1; border-bottom: none; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">13(<sup>b</sup>9)</div>
                <div class="rect" style="background-color: #ffe5dd; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">13(<sup>#</sup>11)</div>
                <div class="rect" style="background-color: #d8ffd1; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>b</sup>9<sup>b</sup>5)</div>
                <div class="rect" style="background-color: #ffe5dd; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>b</sup>9<sup>#</sup>5)</div>
                <div class="rect" style="background-color: #d8ffd1; border-bottom: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Maj(<sup>b</sup>9<sup>#</sup>11)</div>
                <div class="rect" style="background-color: #d8ffd1; border-bottom: none; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">Silence</div>
            </div>
        </div>
    </div>
    <div class="header right-header" style="top: var(--type-top);">
        <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white;">Chord type</span>
        <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white;">Inv: Root &nbsp;&nbsp; | &nbsp;&nbsp; Bass: D &nbsp;&nbsp; | &nbsp;&nbsp; Key: C Maj</span>
    </div>
    <div class="right-container" style="top: var(--duration-top); height: var(--duration-height); background-color: #f7f7f0; box-shadow: 0 4px 8px rgba(0,0,0,0.25);">
        <div class="scroll-container">
            <div class="scroll-content" style="grid-template-columns: repeat(8, 1fr);">
                <div class="rect duration-item" style="background-color: #fffff7; border-left: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">4 Beats</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">3 Beats</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">2 Beats</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">1 Beat</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">1/2 Beat</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">1/4 Beat</div>
                <div class="rect duration-item" style="background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">1/8 Beat</div>
                <div class="rect duration-item" style="background-color: #fffff7; border-right: none; display: flex; align-items: center; justify-content: center; font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px;">1/16 Beat</div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none; border-left: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none;"></div>
                <div class="rect duration-item" style="background-color: #fffff7; border-bottom: none; border-right: none;"></div>
            </div>
        </div>
    </div>
    <div class="header right-header" style="top: var(--duration-top);">
        <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white;">Chord duration</span>
    </div>
    <div class="header left-bottom-header" style="top: calc(100% - var(--gap) - var(--header-height));">
        <span id="insert-btn" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white; cursor: pointer;">Insert</span>
        <span id="remove-btn" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-family: 'Roboto', sans-serif; font-weight: 500; font-size: 14px; color: white; cursor: pointer;">Remove</span>
    </div>
    <div id="viewport-label" style="position: fixed; bottom: 4px; right: 4px; font-family: 'Roboto', sans-serif; font-size: 10px; color: rgba(0,0,0,0.3); pointer-events: none;"></div>

    <!-- Audio Lines Modal -->
    <div id="audio-modal" class="modal-overlay">
        <div class="modal" style="width: 508px; height: 496px;">
            <div class="modal-title"><span>Instrument mixer</span><span>Edit song &nbsp;&nbsp;|&nbsp;&nbsp; <span id="bpm-btn" style="cursor: pointer;">BPM: <span id="bpm-value">70</span></span></span></div>
            <div class="modal-content">
                <div class="modal-inner-container">
                    <div class="modal-scroll-container">
                        <div class="modal-scroll-content">
                            <div class="mixer-row"><span>1. Piano</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>2. Bass</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>3. Empty</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>4. Empty</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>5. Empty</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>6. Empty</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>7. Empty</span><span>Volume 5</span></div>
                            <div class="mixer-row"><span>8. Empty</span><span>Volume 5</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span><span id="reverb-control" style="cursor: pointer;">Reverb: <span id="reverb-value">0</span></span> &nbsp;&nbsp;|&nbsp;&nbsp; <span id="chorus-control" style="cursor: pointer;">Chorus: <span id="chorus-value">0</span></span></span>
                <span>Presets &nbsp;&nbsp;|&nbsp;&nbsp; <span class="modal-close-btn">Close</span></span>
            </div>
        </div>
    </div>

    <!-- Tempo Modal -->
    <div id="tempo-modal" class="modal-overlay">
        <div class="modal" style="width: 508px; height: 496px;">
            <div class="modal-title"><span>Tempo</span><span>Select BPM</span></div>
            <div class="modal-content">
                <div class="modal-inner-container">
                    <div class="modal-scroll-container">
                        <div id="tempo-grid" class="modal-scroll-content" style="grid-template-columns: repeat(6, 1fr);">
                            <!-- Tempo items will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span>Current: <span id="tempo-current">70</span> BPM</span>
                <span class="modal-close-btn" style="cursor: pointer;">Close</span>
            </div>
        </div>
    </div>

    <!-- Reverb Modal -->
    <div id="reverb-modal" class="modal-overlay">
        <div class="modal" style="width: 508px; height: 496px;">
            <div class="modal-title"><span>Reverb</span><span>Select Amount</span></div>
            <div class="modal-content">
                <div class="modal-inner-container">
                    <div class="modal-scroll-container">
                        <div id="reverb-grid" class="modal-scroll-content" style="grid-template-columns: repeat(6, 1fr);">
                            <!-- Reverb items will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span>Current: <span id="reverb-current">0</span></span>
                <span class="modal-close-btn" style="cursor: pointer;">Close</span>
            </div>
        </div>
    </div>

    <!-- Chorus Modal -->
    <div id="chorus-modal" class="modal-overlay">
        <div class="modal" style="width: 508px; height: 496px;">
            <div class="modal-title"><span>Chorus</span><span>Select Amount</span></div>
            <div class="modal-content">
                <div class="modal-inner-container">
                    <div class="modal-scroll-container">
                        <div id="chorus-grid" class="modal-scroll-content" style="grid-template-columns: repeat(6, 1fr);">
                            <!-- Chorus items will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span>Current: <span id="chorus-current">0</span></span>
                <span class="modal-close-btn" style="cursor: pointer;">Close</span>
            </div>
        </div>
    </div>

    <!-- Instrument Detail Modal -->
    <div id="instrument-modal" class="modal-overlay">
        <div class="modal" style="width: 508px; height: 496px;">
            <div class="modal-title"><span id="instrument-modal-title">1. Piano</span><span>Settings</span></div>
            <div class="modal-content">
                <div class="modal-inner-container">
                    <div class="modal-scroll-container">
                        <div id="instrument-grid" class="modal-scroll-content" style="grid-template-columns: 1fr 2fr 1fr;">
                            <!-- Instrument items will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span>Instrument: <span id="instrument-current">Piano</span></span>
                <span class="modal-close-btn" style="cursor: pointer;">Close</span>
            </div>
        </div>
    </div>

    <script>
        function updateViewportLabel() {
            document.getElementById('viewport-label').textContent = window.innerWidth + ' x ' + window.innerHeight;
        }

        updateViewportLabel();
        window.addEventListener('resize', updateViewportLabel);

        lucide.createIcons();

        // ============================================
        // AUDIO ENGINE - Multi-sampling with detune
        // Based on: https://www.gregjopa.com/2023/03/piano-sounds-with-web-audio-api
        // Uses C2, C4, C6 samples to limit pitch shifting to Â±12 semitones
        // ============================================

        let audioContext = null;
        let isPlaying = false;
        let audioReady = false;

        // Multi-sample buffers - 17 samples every 3 semitones for high quality
        // Semitone values relative to C4 (C4 = 0)
        const sampleDefinitions = [
            { name: 'C2', semitone: -24 },
            { name: 'D#2', semitone: -21 },
            { name: 'F#2', semitone: -18 },
            { name: 'A2', semitone: -15 },
            { name: 'C3', semitone: -12 },
            { name: 'D#3', semitone: -9 },
            { name: 'F#3', semitone: -6 },
            { name: 'A3', semitone: -3 },
            { name: 'C4', semitone: 0 },
            { name: 'D#4', semitone: 3 },
            { name: 'F#4', semitone: 6 },
            { name: 'A4', semitone: 9 },
            { name: 'C5', semitone: 12 },
            { name: 'D#5', semitone: 15 },
            { name: 'F#5', semitone: 18 },
            { name: 'A5', semitone: 21 },
            { name: 'C6', semitone: 24 }
        ];

        const sampleBuffers = {};

        let currentBPM = 70;
        function getBeatDuration() {
            return 60 / currentBPM * 1000; // ms per beat
        }

        // Reverb settings
        let reverbAmount = 0;
        let convolver = null;
        let dryGain = null;
        let wetGain = null;

        // Create impulse response for reverb
        function createImpulseResponse(duration = 2.5, decay = 2.0) {
            const sampleRate = audioContext.sampleRate;
            const length = sampleRate * duration;
            const impulse = audioContext.createBuffer(2, length, sampleRate);
            const leftChannel = impulse.getChannelData(0);
            const rightChannel = impulse.getChannelData(1);

            for (let i = 0; i < length; i++) {
                const n = i / length;
                const envelope = Math.pow(1 - n, decay);
                leftChannel[i] = (Math.random() * 2 - 1) * envelope;
                rightChannel[i] = (Math.random() * 2 - 1) * envelope;
            }

            return impulse;
        }

        // Setup reverb nodes
        function setupReverb() {
            if (!audioContext) return;

            convolver = audioContext.createConvolver();
            convolver.buffer = createImpulseResponse(2.5, 2.0);

            dryGain = audioContext.createGain();
            wetGain = audioContext.createGain();

            // Initial mix (no reverb)
            updateReverbMix();

            // Connect wet path through convolver
            convolver.connect(wetGain);
            wetGain.connect(audioContext.destination);
            dryGain.connect(audioContext.destination);
        }

        // Update reverb wet/dry mix based on reverbAmount (0-100)
        function updateReverbMix() {
            if (!dryGain || !wetGain) return;

            const wetLevel = reverbAmount / 100;

            // Keep dry signal at full volume, just add reverb on top
            dryGain.gain.value = 1.0;
            wetGain.gain.value = wetLevel * 1.2;
        }

        // Chorus settings
        let chorusAmount = 0;
        let chorusDelay1 = null;
        let chorusDelay2 = null;
        let chorusGain = null;
        let chorusLfo1 = null;
        let chorusLfo2 = null;
        let chorusLfoGain1 = null;
        let chorusLfoGain2 = null;

        // Setup chorus effect (uses delay with LFO modulation)
        function setupChorus() {
            if (!audioContext) return;

            // Create two delay lines for stereo chorus
            chorusDelay1 = audioContext.createDelay(0.1);
            chorusDelay2 = audioContext.createDelay(0.1);
            chorusDelay1.delayTime.value = 0.025;
            chorusDelay2.delayTime.value = 0.030;

            // LFOs to modulate delay times
            chorusLfo1 = audioContext.createOscillator();
            chorusLfo2 = audioContext.createOscillator();
            chorusLfo1.type = 'sine';
            chorusLfo2.type = 'sine';
            chorusLfo1.frequency.value = 0.5;
            chorusLfo2.frequency.value = 0.7;

            // LFO gain (depth of modulation)
            chorusLfoGain1 = audioContext.createGain();
            chorusLfoGain2 = audioContext.createGain();
            chorusLfoGain1.gain.value = 0.002;
            chorusLfoGain2.gain.value = 0.002;

            // Connect LFOs to delay time modulation
            chorusLfo1.connect(chorusLfoGain1);
            chorusLfo2.connect(chorusLfoGain2);
            chorusLfoGain1.connect(chorusDelay1.delayTime);
            chorusLfoGain2.connect(chorusDelay2.delayTime);

            // Start LFOs
            chorusLfo1.start();
            chorusLfo2.start();

            // Chorus output gain
            chorusGain = audioContext.createGain();
            chorusGain.gain.value = 0;

            // Stereo panner for chorus
            const chorusPanLeft = audioContext.createStereoPanner();
            const chorusPanRight = audioContext.createStereoPanner();
            chorusPanLeft.pan.value = -0.5;
            chorusPanRight.pan.value = 0.5;

            // Connect delays through panners to gain
            chorusDelay1.connect(chorusPanLeft);
            chorusDelay2.connect(chorusPanRight);
            chorusPanLeft.connect(chorusGain);
            chorusPanRight.connect(chorusGain);

            // Connect to destination
            chorusGain.connect(audioContext.destination);
        }

        // Update chorus mix based on chorusAmount (0-100)
        function updateChorusMix() {
            if (!chorusGain || !chorusLfoGain1 || !chorusLfoGain2) return;

            const level = chorusAmount / 100;

            // Adjust chorus level and modulation depth
            chorusGain.gain.value = level * 0.6;
            chorusLfoGain1.gain.value = 0.001 + (level * 0.003);
            chorusLfoGain2.gain.value = 0.001 + (level * 0.003);
        }

        // Note to semitone offset from C4 (C4 = 0)
        const noteToSemitone = {
            'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
            'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
        };

        // Chord intervals (semitones from root)
        const chordIntervals = {
            'Maj': [0, 4, 7],
            'Min': [0, 3, 7],
            'Dim': [0, 3, 6],
            '6': [0, 4, 7, 9],
            'min6': [0, 3, 7, 9],
            'Aug': [0, 4, 8],
            'Maj7': [0, 4, 7, 11],
            'Min7': [0, 3, 7, 10],
            '7': [0, 4, 7, 10],
            'Maj9': [0, 4, 7, 11, 14],
            'Min9': [0, 3, 7, 10, 14],
            '9': [0, 4, 7, 10, 14],
            'Sus2': [0, 2, 7],
            'Sus4': [0, 5, 7],
            '5': [0, 7],
            'Dim7': [0, 3, 6, 9]
        };

        // Load a single audio sample
        async function loadSample(url) {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        }

        // Initialize audio with multi-sampling (17 samples)
        async function initAudio() {
            if (audioContext) return;

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Resume if suspended (required for user interaction)
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // Load all 17 samples in parallel
                // URL-encode # as %23 for sharp notes
                const loadPromises = sampleDefinitions.map(def => {
                    const encodedName = def.name.replace('#', '%23');
                    return loadSample(`sounds/${encodedName}v11.wav`);
                });

                const buffers = await Promise.all(loadPromises);

                // Store buffers with their semitone values
                sampleDefinitions.forEach((def, index) => {
                    sampleBuffers[def.name] = {
                        buffer: buffers[index],
                        semitone: def.semitone
                    };
                });

                // Setup reverb and chorus
                setupReverb();
                setupChorus();

                audioReady = true;
                console.log('Audio initialized - 17 samples loaded');
            } catch (e) {
                console.log('Could not initialize audio:', e);
            }
        }

        /**
         * Choose the best sample to minimize pitch shifting
         * With 17 samples, max shift is only Â±1.5 semitones
         * Returns { buffer, detune } where detune is in semitones
         */
        function chooseSample(targetSemitone) {
            let closestSample = null;
            let minDistance = Infinity;

            // Find the sample with minimum pitch shift needed
            for (const def of sampleDefinitions) {
                const distance = Math.abs(targetSemitone - def.semitone);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestSample = def;
                }
            }

            const sampleData = sampleBuffers[closestSample.name];
            return {
                buffer: sampleData.buffer,
                detune: targetSemitone - closestSample.semitone
            };
        }

        /**
         * Play a tone using multi-sampling + detune for high-quality pitch shifting
         * Minimal processing to preserve original sample quality
         */
        function playTone(semitoneOffset, time, velocity = 100, duration = 2, pan = 0) {
            if (!audioContext || !audioReady) return;

            // Resume context if needed
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            // Choose best sample to minimize pitch shifting
            const { buffer, detune } = chooseSample(semitoneOffset);
            if (!buffer) return;

            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();

            source.buffer = buffer;

            // Use detune for pitch shifting (100 cents = 1 semitone)
            const cents = detune * 100;
            if (source.detune) {
                source.detune.value = cents;
            } else {
                source.playbackRate.value = Math.pow(2, detune / 12);
            }

            // Simple velocity to gain
            const gain = (velocity / 127) * 0.7;

            // Minimal envelope - just set gain and let sample play naturally
            gainNode.gain.setValueAtTime(gain, time);

            // Long sustain with gradual fade for ballad feel
            const sustainEnd = time + duration * 0.85;
            gainNode.gain.setValueAtTime(gain, sustainEnd);

            // Smooth extended release for sustain
            const releaseEnd = time + duration + 1.2;
            gainNode.gain.exponentialRampToValueAtTime(0.001, releaseEnd);

            // Stereo panning
            let outputNode = gainNode;
            if (pan !== 0 && audioContext.createStereoPanner) {
                const panner = audioContext.createStereoPanner();
                panner.pan.value = pan;
                gainNode.connect(panner);
                outputNode = panner;
            }

            // Connect to destination (through reverb and chorus if available)
            source.connect(gainNode);
            if (convolver && dryGain && wetGain) {
                outputNode.connect(dryGain);
                outputNode.connect(convolver);
                // Also connect to chorus if available
                if (chorusDelay1 && chorusDelay2) {
                    outputNode.connect(chorusDelay1);
                    outputNode.connect(chorusDelay2);
                }
            } else {
                outputNode.connect(audioContext.destination);
            }

            // Schedule playback
            source.start(time);
            source.stop(releaseEnd + 0.3);

            // Track active nodes for fadeout on pause
            const nodeInfo = { source, gainNode, releaseEnd };
            activeNodes.push(nodeInfo);

            // Clean up from activeNodes when done
            source.onended = () => {
                const index = activeNodes.indexOf(nodeInfo);
                if (index > -1) activeNodes.splice(index, 1);
            };
        }

        // Fadeout all active notes (called when pausing)
        function fadeoutAllNotes(duration = 1.5) {
            const now = audioContext.currentTime;
            activeNodes.forEach(({ source, gainNode }) => {
                try {
                    // Use linearRampToValueAtTime which smoothly transitions from current value
                    // without needing to cancel or set the current value first
                    gainNode.gain.linearRampToValueAtTime(0.001, now + duration);
                    // Stop source after fadeout
                    source.stop(now + duration + 0.1);
                } catch (e) {
                    // Source may have already stopped
                }
            });
        }

        // Scheduler variables for precise timing
        let schedulerTimer = null;
        let beatIndicatorTimer = null;
        const scheduleAheadTime = 0.1; // seconds
        const schedulerInterval = 25; // ms

        // Track active audio nodes for fadeout on pause
        let activeNodes = [];

        // Progression playback state
        let currentChordIndex = 0;
        let nextPatternTime = 0;
        let scheduledChords = [];
        let lastDisplayedChordIndex = -1;
        let lastDisplayedBeat = -1;

        // Duration text to beats
        function durationToBeats(durationText) {
            const map = {
                '4 Beats': 4, '3 Beats': 3, '2 Beats': 2, '1 Beat': 1,
                '1/2 Beat': 0.5, '1/4 Beat': 0.25, '1/8 Beat': 0.125, '1/16 Beat': 0.0625
            };
            return map[durationText] || 4;
        }

        // Get chords from progression list
        function getProgressionChords() {
            const chordItems = document.querySelectorAll('#chord-list .chord-item');
            const chords = [];
            chordItems.forEach(item => {
                const nameSpan = item.querySelector('.chord-name');
                const durationSpan = item.querySelector('.chord-duration');
                if (nameSpan) {
                    const parts = nameSpan.textContent.trim().split(' ');
                    chords.push({
                        root: parts[0],
                        type: parts.slice(1).join(' ') || 'Maj',
                        duration: durationSpan ? durationSpan.textContent.trim() : '4 Beats',
                        element: item
                    });
                }
            });
            return chords;
        }

        /**
         * Slight humanization for more natural feel
         */
        function humanize(value, amount = 0.01) {
            return value + (Math.random() - 0.5) * amount;
        }

        /**
         * Schedule ballad pattern for a chord
         * Pattern per beat:
         * Beat 1: Bass (v100) + Chord (v100)
         * Beat 1.5: Fill note (v50)
         * Beat 2: Chord (v60)
         * Beat 2.5: Fill note (v50)
         * ... etc
         */
        function scheduleBalladPattern(rootNote, chordType, startTime, numBeats) {
            if (!audioContext || !audioReady) return;

            const rootSemitone = noteToSemitone[rootNote] || 0;
            const intervals = chordIntervals[chordType] || chordIntervals['Maj'];
            const beatSec = getBeatDuration() / 1000;

            // Find the 5th interval for fill notes
            const fifthInterval = intervals.find(i => i === 7) !== undefined ? 7 : (intervals[intervals.length - 1] || 7);

            // For notes F-B (semitone > 4), shift chord down an octave to avoid too high pitch
            const chordOctaveOffset = rootSemitone > 4 ? -12 : 0;

            // Stereo spread for chord notes (-0.3 to +0.3)
            const getPan = (index, total) => {
                if (total <= 1) return 0;
                return ((index / (total - 1)) - 0.5) * 0.6;
            };

            // Beat 1: Bass note (one octave below chord) + full chord
            // Bass sustains through entire chord duration + extra overlap
            const bassNote = rootSemitone - 12 + chordOctaveOffset;
            playTone(bassNote, startTime, 100, numBeats * beatSec + 1.0, 0);

            // Chord notes with slight stagger - long sustain
            intervals.forEach((interval, i) => {
                const noteTime = startTime + i * 0.012;
                const pan = getPan(i, intervals.length);
                playTone(rootSemitone + interval + chordOctaveOffset, noteTime, 100, beatSec * 2.5, pan);
            });

            // Schedule remaining beats
            for (let beat = 1; beat < numBeats; beat++) {
                const beatTime = startTime + beat * beatSec;

                // Half-beat fill (e.g., beat 1.5, 2.5, etc.) - longer sustain
                const halfBeatTime = beatTime - beatSec * 0.5;
                if (halfBeatTime > startTime) {
                    playTone(rootSemitone + fifthInterval - 12 + chordOctaveOffset,
                             halfBeatTime, 50, beatSec * 1.5, 0);
                }

                // On-beat chord - extended sustain
                intervals.forEach((interval, i) => {
                    const noteTime = beatTime + i * 0.012;
                    const pan = getPan(i, intervals.length);
                    playTone(rootSemitone + interval + chordOctaveOffset, noteTime, 60, beatSec * 2.0, pan);
                });
            }

            // Final half-beat fill before next chord
            if (numBeats >= 1) {
                const lastHalfBeat = startTime + (numBeats - 0.5) * beatSec;
                playTone(rootSemitone + fifthInterval - 12 + chordOctaveOffset,
                         lastHalfBeat, 50, beatSec * 1.2, 0);
            }
        }

        // Update beat indicator visuals
        function updateBeatIndicator() {
            if (!isPlaying) return;

            const currentTime = audioContext.currentTime;
            const beatSec = getBeatDuration() / 1000;

            // Find current chord and beat
            for (let i = scheduledChords.length - 1; i >= 0; i--) {
                const scheduled = scheduledChords[i];
                if (currentTime >= scheduled.startTime) {
                    const timeIntoChord = currentTime - scheduled.startTime;
                    const numBeats = scheduled.numBeats;
                    const currentBeat = Math.min(Math.floor(timeIntoChord / beatSec), numBeats - 1);

                    if (scheduled.chordIndex !== lastDisplayedChordIndex || currentBeat !== lastDisplayedBeat) {
                        lastDisplayedChordIndex = scheduled.chordIndex;
                        lastDisplayedBeat = currentBeat;

                        const blockWidth = 100 / numBeats;
                        const blockLeft = currentBeat * blockWidth;
                        const chords = getProgressionChords();

                        // Clear old indicators
                        document.querySelectorAll('.beat-indicator').forEach(ind => ind.remove());
                        document.querySelectorAll('.chord-item').forEach(item => item.classList.remove('playing'));

                        if (chords[scheduled.chordIndex]) {
                            const chordElement = chords[scheduled.chordIndex].element;
                            chordElement.classList.add('playing');

                            const indicator = document.createElement('div');
                            indicator.className = 'beat-indicator';
                            indicator.style.setProperty('--beat-left', blockLeft + '%');
                            indicator.style.setProperty('--beat-width', blockWidth + '%');
                            chordElement.appendChild(indicator);

                            requestAnimationFrame(() => indicator.classList.add('animate'));
                        }
                    }
                    break;
                }
            }

            // Cleanup old scheduled chords
            scheduledChords = scheduledChords.filter(s => currentTime < s.startTime + (s.numBeats * beatSec) + 1);

            beatIndicatorTimer = requestAnimationFrame(updateBeatIndicator);
        }

        // Lookahead scheduler
        function scheduler() {
            const beatSec = getBeatDuration() / 1000;
            const chords = getProgressionChords();

            if (chords.length === 0) {
                togglePlay();
                return;
            }

            while (nextPatternTime < audioContext.currentTime + scheduleAheadTime) {
                const chord = chords[currentChordIndex];
                const numBeats = durationToBeats(chord.duration);

                scheduleBalladPattern(chord.root, chord.type, nextPatternTime, numBeats);

                scheduledChords.push({
                    chordIndex: currentChordIndex,
                    startTime: nextPatternTime,
                    numBeats: numBeats
                });

                nextPatternTime += numBeats * beatSec;
                currentChordIndex = (currentChordIndex + 1) % chords.length;
            }

            schedulerTimer = setTimeout(scheduler, schedulerInterval);
        }

        // Toggle play/pause
        function togglePlay() {
            if (isPlaying) {
                // Stop
                isPlaying = false;
                if (schedulerTimer) {
                    clearTimeout(schedulerTimer);
                    schedulerTimer = null;
                }
                if (beatIndicatorTimer) {
                    cancelAnimationFrame(beatIndicatorTimer);
                    beatIndicatorTimer = null;
                }

                // Fadeout all playing notes smoothly
                fadeoutAllNotes(1.5);

                // Clear visuals
                document.querySelectorAll('.beat-indicator').forEach(ind => ind.remove());
                document.querySelectorAll('.chord-item').forEach(item => item.classList.remove('playing'));

                // Update icon
                document.querySelectorAll('.play-btn[data-lucide="pause"]').forEach(icon => {
                    icon.setAttribute('data-lucide', 'play');
                    icon.style.fill = 'white';
                });
                lucide.createIcons();
            } else {
                // Start
                isPlaying = true;

                // Update icon
                document.querySelectorAll('.play-btn[data-lucide="play"]').forEach(icon => {
                    icon.setAttribute('data-lucide', 'pause');
                    icon.style.fill = 'white';
                });
                lucide.createIcons();

                // Reset state
                currentChordIndex = 0;
                scheduledChords = [];
                lastDisplayedChordIndex = -1;
                lastDisplayedBeat = -1;
                nextPatternTime = audioContext.currentTime;

                scheduler();
                updateBeatIndicator();
            }
        }

        // Initialize on first click
        document.addEventListener('click', initAudio, { once: true });

        // Play button handler
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.play-btn')) {
                e.stopPropagation();
                await initAudio();
                if (audioReady) {
                    togglePlay();
                }
            }
        });

        // ============================================
        // UI INTERACTIONS
        // ============================================

        // Smooth scroll with momentum
        document.querySelectorAll('.scroll-container, .modal-scroll-container').forEach(container => {
            const content = container.querySelector('.scroll-content, .modal-scroll-content');
            let isDragging = false;
            let scrollY = 0;
            let lastPointerY = 0;
            let lastTime = 0;
            let velocity = 0;
            let animationId = null;
            const rubberBandFactor = 0.3;
            const friction = 0.95;
            const minVelocity = 0.5;

            function getMaxScroll() {
                return Math.max(0, content.scrollHeight - container.clientHeight);
            }

            function getPointerY(e) {
                return e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
            }

            function applyRubberBand(value) {
                const maxScroll = getMaxScroll();
                if (value > 0) return value * rubberBandFactor;
                if (value < -maxScroll) return -maxScroll + (value + maxScroll) * rubberBandFactor;
                return value;
            }

            function isOutOfBounds() {
                const maxScroll = getMaxScroll();
                return scrollY > 0 || scrollY < -maxScroll;
            }

            function updateTransform(value) {
                content.style.transform = `translateY(${value}px)`;
            }

            function snapToBounds() {
                const maxScroll = getMaxScroll();
                content.classList.add('animating');
                if (scrollY > 0) scrollY = 0;
                else if (scrollY < -maxScroll) scrollY = -maxScroll;
                updateTransform(scrollY);
                setTimeout(() => content.classList.remove('animating'), 400);
            }

            function momentumLoop() {
                if (isDragging) return;
                velocity *= friction;
                scrollY += velocity;

                if (isOutOfBounds()) {
                    velocity *= 0.5;
                    if (Math.abs(velocity) < minVelocity) {
                        velocity = 0;
                        snapToBounds();
                        return;
                    }
                }

                updateTransform(applyRubberBand(scrollY));

                if (Math.abs(velocity) > minVelocity) {
                    animationId = requestAnimationFrame(momentumLoop);
                } else if (isOutOfBounds()) {
                    snapToBounds();
                }
            }

            function stopMomentum() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                velocity = 0;
            }

            function onStart(e) {
                isDragging = true;
                stopMomentum();
                content.classList.remove('animating');
                lastPointerY = getPointerY(e);
                lastTime = Date.now();
                velocity = 0;
            }

            function onMove(e) {
                if (!isDragging) return;
                e.preventDefault();
                const pointerY = getPointerY(e);
                const now = Date.now();
                const delta = pointerY - lastPointerY;
                const dt = now - lastTime;
                if (dt > 0) velocity = delta / dt * 16;
                lastPointerY = pointerY;
                lastTime = now;
                scrollY += delta;
                updateTransform(applyRubberBand(scrollY));
            }

            function onEnd() {
                if (!isDragging) return;
                isDragging = false;
                if (isOutOfBounds() || Math.abs(velocity) < minVelocity) {
                    snapToBounds();
                } else {
                    animationId = requestAnimationFrame(momentumLoop);
                }
            }

            function onWheel(e) {
                e.preventDefault();
                stopMomentum();
                content.classList.remove('animating');
                scrollY -= e.deltaY;
                updateTransform(applyRubberBand(scrollY));
                clearTimeout(container.wheelTimeout);
                container.wheelTimeout = setTimeout(() => {
                    if (isOutOfBounds()) snapToBounds();
                }, 150);
            }

            container.addEventListener('touchstart', onStart, { passive: true });
            container.addEventListener('touchmove', onMove, { passive: false });
            container.addEventListener('touchend', onEnd);
            container.addEventListener('touchcancel', onEnd);
            container.addEventListener('mousedown', onStart);
            container.addEventListener('mousemove', onMove);
            container.addEventListener('mouseup', onEnd);
            container.addEventListener('mouseleave', onEnd);
            container.addEventListener('wheel', onWheel, { passive: false });
        });

        // Chord selection
        let selectedRoot = 'C';
        let selectedType = 'Maj';
        let selectedDuration = '4 Beats';
        let selectedChordItem = null;

        function updateSelectedChord() {
            if (selectedChordItem) {
                const nameSpan = selectedChordItem.querySelector('.chord-name');
                const durationSpan = selectedChordItem.querySelector('.chord-duration');
                if (nameSpan) nameSpan.textContent = selectedRoot + ' ' + selectedType;
                if (durationSpan) durationSpan.textContent = selectedDuration;
            }
        }

        document.querySelector('.root-note[data-note="C"]').classList.add('selected');
        document.querySelector('.chord-type[data-type="Maj"]').classList.add('selected');

        document.querySelectorAll('.root-note').forEach(note => {
            note.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.root-note').forEach(n => n.classList.remove('selected'));
                note.classList.add('selected');
                selectedRoot = note.dataset.note;
                updateSelectedChord();
            });
        });

        document.querySelectorAll('.chord-type').forEach(type => {
            type.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.chord-type').forEach(t => t.classList.remove('selected'));
                type.classList.add('selected');
                selectedType = type.textContent.trim();
                updateSelectedChord();
            });
        });

        document.querySelectorAll('#chord-type-grid .rect').forEach(rect => {
            if (!rect.classList.contains('chord-type')) {
                rect.classList.add('chord-type');
                rect.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.chord-type').forEach(t => t.classList.remove('selected'));
                    rect.classList.add('selected');
                    selectedType = rect.textContent.trim();
                    updateSelectedChord();
                });
            }
        });

        function selectChordItem(item) {
            document.querySelectorAll('.chord-item').forEach(c => c.classList.remove('selected'));
            item.classList.add('selected');
            selectedChordItem = item;

            const nameSpan = item.querySelector('.chord-name');
            const durationSpan = item.querySelector('.chord-duration');

            if (nameSpan) {
                const parts = nameSpan.textContent.trim().split(' ');
                if (parts.length >= 2) {
                    selectedRoot = parts[0];
                    selectedType = parts.slice(1).join(' ');

                    document.querySelectorAll('.root-note').forEach(n => n.classList.remove('selected'));
                    const rootNote = document.querySelector('.root-note[data-note="' + selectedRoot + '"]');
                    if (rootNote) rootNote.classList.add('selected');

                    document.querySelectorAll('.chord-type').forEach(t => t.classList.remove('selected'));
                    document.querySelectorAll('.chord-type').forEach(t => {
                        if (t.textContent.trim() === selectedType) t.classList.add('selected');
                    });
                }
            }

            if (durationSpan) {
                selectedDuration = durationSpan.textContent.trim();
                document.querySelectorAll('.duration-item').forEach(d => d.classList.remove('selected'));
                document.querySelectorAll('.duration-item').forEach(d => {
                    if (d.textContent.trim() === selectedDuration) d.classList.add('selected');
                });
            }
        }

        document.querySelectorAll('.chord-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                selectChordItem(item);
            });
        });

        document.getElementById('insert-btn').addEventListener('click', () => {
            const chordList = document.getElementById('chord-list');
            const chordName = selectedRoot + ' ' + selectedType;

            const newChord = document.createElement('div');
            newChord.className = 'rect chord-item';
            newChord.style.cssText = 'background-color: #fffff7; border-left: none; border-right: none; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);';
            newChord.innerHTML = '<span class="chord-name">' + chordName + '</span><span class="chord-duration">' + selectedDuration + '</span>';

            newChord.addEventListener('click', (e) => {
                e.stopPropagation();
                selectChordItem(newChord);
            });

            chordList.appendChild(newChord);
            selectChordItem(newChord);
        });

        const audioModal = document.getElementById('audio-modal');

        document.addEventListener('click', (e) => {
            if (e.target.closest('.audio-lines-btn')) {
                e.stopPropagation();
                audioModal.classList.add('active');
            }
        });

        audioModal.querySelector('.modal-close-btn').addEventListener('click', () => {
            audioModal.classList.remove('active');
        });

        audioModal.addEventListener('click', (e) => {
            if (e.target === audioModal) audioModal.classList.remove('active');
        });

        document.querySelectorAll('.mixer-row').forEach(row => {
            row.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.mixer-row').forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
            });
        });

        document.querySelectorAll('.duration-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.duration-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                const durationText = item.textContent.trim();
                if (durationText) {
                    selectedDuration = durationText;
                    updateSelectedChord();
                }
            });
        });

        document.querySelector('.duration-item').classList.add('selected');

        const firstChord = document.querySelector('.chord-item');
        if (firstChord) selectChordItem(firstChord);

        document.getElementById('remove-btn').addEventListener('click', () => {
            if (selectedChordItem) {
                const chordList = document.getElementById('chord-list');
                selectedChordItem.remove();
                const remainingChords = chordList.querySelectorAll('.chord-item');
                if (remainingChords.length > 0) {
                    selectChordItem(remainingChords[remainingChords.length - 1]);
                } else {
                    selectedChordItem = null;
                }
            }
        });

        // Reverb modal
        const reverbModal = document.getElementById('reverb-modal');
        const reverbGrid = document.getElementById('reverb-grid');

        // Generate reverb items from 0 to 100
        function generateReverbItems() {
            reverbGrid.innerHTML = '';
            for (let level = 0; level <= 100; level++) {
                const item = document.createElement('div');
                item.className = 'rect reverb-item';
                item.dataset.level = level;
                item.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);';
                item.textContent = level;

                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.reverb-item').forEach(t => t.classList.remove('selected'));
                    item.classList.add('selected');

                    reverbAmount = level;
                    updateReverbMix();

                    // Update all reverb displays
                    document.getElementById('reverb-value').textContent = level;
                    document.getElementById('reverb-current').textContent = level;

                    // Close reverb modal after selection
                    reverbModal.classList.remove('active');
                });

                reverbGrid.appendChild(item);
            }
        }

        generateReverbItems();

        document.getElementById('reverb-control').addEventListener('click', (e) => {
            e.stopPropagation();
            reverbModal.classList.add('active');
            // Highlight current reverb level
            document.querySelectorAll('.reverb-item').forEach(item => {
                item.classList.remove('selected');
                if (parseInt(item.dataset.level) === reverbAmount) {
                    item.classList.add('selected');
                }
            });
        });

        reverbModal.querySelector('.modal-close-btn').addEventListener('click', () => {
            reverbModal.classList.remove('active');
        });

        reverbModal.addEventListener('click', (e) => {
            if (e.target === reverbModal) reverbModal.classList.remove('active');
        });

        // Chorus modal
        const chorusModal = document.getElementById('chorus-modal');
        const chorusGrid = document.getElementById('chorus-grid');

        // Generate chorus items from 0 to 100
        function generateChorusItems() {
            chorusGrid.innerHTML = '';
            for (let level = 0; level <= 100; level++) {
                const item = document.createElement('div');
                item.className = 'rect chorus-item';
                item.dataset.level = level;
                item.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);';
                item.textContent = level;

                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.chorus-item').forEach(t => t.classList.remove('selected'));
                    item.classList.add('selected');

                    chorusAmount = level;
                    updateChorusMix();

                    // Update all chorus displays
                    document.getElementById('chorus-value').textContent = level;
                    document.getElementById('chorus-current').textContent = level;

                    // Close chorus modal after selection
                    chorusModal.classList.remove('active');
                });

                chorusGrid.appendChild(item);
            }
        }

        generateChorusItems();

        document.getElementById('chorus-control').addEventListener('click', (e) => {
            e.stopPropagation();
            chorusModal.classList.add('active');
            // Highlight current chorus level
            document.querySelectorAll('.chorus-item').forEach(item => {
                item.classList.remove('selected');
                if (parseInt(item.dataset.level) === chorusAmount) {
                    item.classList.add('selected');
                }
            });
        });

        chorusModal.querySelector('.modal-close-btn').addEventListener('click', () => {
            chorusModal.classList.remove('active');
        });

        chorusModal.addEventListener('click', (e) => {
            if (e.target === chorusModal) chorusModal.classList.remove('active');
        });

        // Tempo modal
        const tempoModal = document.getElementById('tempo-modal');
        const tempoGrid = document.getElementById('tempo-grid');

        // Generate tempo items from 40 to 399
        function generateTempoItems() {
            tempoGrid.innerHTML = '';
            for (let bpm = 40; bpm <= 399; bpm++) {
                const item = document.createElement('div');
                item.className = 'rect tempo-item';
                item.dataset.bpm = bpm;
                item.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);';
                item.textContent = bpm;

                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.tempo-item').forEach(t => t.classList.remove('selected'));
                    item.classList.add('selected');

                    currentBPM = bpm;

                    // Update all BPM displays
                    document.getElementById('bpm-value').textContent = bpm;
                    document.getElementById('tempo-current').textContent = bpm;

                    // Close tempo modal after selection
                    tempoModal.classList.remove('active');
                });

                tempoGrid.appendChild(item);
            }
        }

        generateTempoItems();

        document.getElementById('bpm-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            tempoModal.classList.add('active');
            // Highlight current tempo
            document.querySelectorAll('.tempo-item').forEach(item => {
                item.classList.remove('selected');
                if (parseInt(item.dataset.bpm) === currentBPM) {
                    item.classList.add('selected');
                }
            });
        });

        tempoModal.querySelector('.modal-close-btn').addEventListener('click', () => {
            tempoModal.classList.remove('active');
        });

        tempoModal.addEventListener('click', (e) => {
            if (e.target === tempoModal) tempoModal.classList.remove('active');
        });

        // Instrument detail modal
        const instrumentModal = document.getElementById('instrument-modal');
        const instrumentGrid = document.getElementById('instrument-grid');
        let currentMixerRowIndex = 0;

        // Generate instrument grid items (3 columns: 1fr 2fr 1fr)
        function generateInstrumentItems(rowIndex, instrumentName) {
            instrumentGrid.innerHTML = '';

            // Sample data for the 3-column layout
            // Left column: Categories
            const leftItems = ['Type', 'Sound', 'Octave', 'Pan', 'Attack', 'Release', 'Filter', 'Drive'];
            // Center column: Values/Options (twice as wide)
            const centerItems = ['Piano', 'Grand Piano', '4', 'Center', '50ms', '500ms', 'Off', '0%'];
            // Right column: Actions/Indicators
            const rightItems = ['â¼', 'â¼', 'â¼', 'â¼', 'â¼', 'â¼', 'â¼', 'â¼'];

            const numRows = leftItems.length;

            for (let i = 0; i < numRows; i++) {
                // Left item
                const leftItem = document.createElement('div');
                leftItem.className = 'rect instrument-item';
                leftItem.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.5);';
                leftItem.textContent = leftItems[i];
                instrumentGrid.appendChild(leftItem);

                // Center item (main value)
                const centerItem = document.createElement('div');
                centerItem.className = 'rect instrument-item';
                centerItem.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.7);';
                centerItem.textContent = centerItems[i];
                centerItem.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Toggle selection
                    document.querySelectorAll('.instrument-item').forEach(t => t.classList.remove('selected'));
                    centerItem.classList.add('selected');
                });
                instrumentGrid.appendChild(centerItem);

                // Right item
                const rightItem = document.createElement('div');
                rightItem.className = 'rect instrument-item';
                rightItem.style.cssText = 'background-color: #fffff7; display: flex; align-items: center; justify-content: center; font-family: \'Roboto\', sans-serif; font-weight: 500; font-size: 14px; color: rgba(0,0,0,0.3);';
                rightItem.textContent = rightItems[i];
                instrumentGrid.appendChild(rightItem);
            }

            // Update modal title
            document.getElementById('instrument-modal-title').textContent = instrumentName;
            document.getElementById('instrument-current').textContent = instrumentName.split('. ')[1] || instrumentName;
        }

        // Add click handlers to mixer rows
        document.querySelectorAll('.mixer-row').forEach((row, index) => {
            row.style.cursor = 'pointer';
            row.addEventListener('click', (e) => {
                e.stopPropagation();
                currentMixerRowIndex = index;
                const instrumentName = row.querySelector('span').textContent;
                generateInstrumentItems(index, instrumentName);
                instrumentModal.classList.add('active');
            });
        });

        instrumentModal.querySelector('.modal-close-btn').addEventListener('click', () => {
            instrumentModal.classList.remove('active');
        });

        instrumentModal.addEventListener('click', (e) => {
            if (e.target === instrumentModal) instrumentModal.classList.remove('active');
        });
    </script>



</body></html>